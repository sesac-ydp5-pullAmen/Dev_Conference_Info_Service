<!DOCTYPE html>
<html lang="ko">

<head>
    <%- include('../../common/head.ejs', {title: '행사 글 작성' }) %>
</head>

<body>
    <%- include('../../common/header.ejs') %>
        <main>
            <div class="wrap">
                <form NAME="register-conference">
                    <div class="mb-3">
                        <label for="formFile" class="form-label"></label>
                        <input id="dynamic-file" class="form-control" type="file" id="formFile" name="conferenceFile">
                    </div>

                    <h1>행사 기본 정보</h1>
                    <br />
                    <div class="row mb-3">
                        <label for="conTitle" class="col-sm-2 col-form-label">행사 이름</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="conTitle" name="conTitle" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="conDetail" class="form-label">행사 상세 내용</label>
                        <textarea class="form-control" id="conDetail" name="conDetail" rows="3"></textarea>
                    </div>
                    <div class="row mb-3">
                        <label for="conCompany" class="col-sm-2 col-form-label">행사 주최</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="conCompany" name="conCompany" />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label for="conCompanyUrl" class="col-sm-2 col-form-label">행사 주최 URL</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="conCompanyUrl" name="conCompanyUrl" />
                        </div>
                    </div>
                    <fieldset class="row mb-3">
                        <legend class="col-form-label col-sm-2 pt-0">
                            행사 카테고리
                        </legend>
                        <select class="form-select" aria-label="Default select example" id="conCategory"
                            name="conCategory">
                            <option selected name="conCategory">
                                카테고리를 선택해주세요.
                            </option>
                            <option value="AI">AI</option>
                            <option value="web">웹 개발</option>
                            <option value="git">git</option>
                        </select>
                    </fieldset>
                    <hr />
                    <div>
                        <h1>행사 시간</h1>
                        <br />
                        <div class="row mb-3">
                            <label for="conStartDate" class="col-sm-2 col-form-label">행사 시작일</label>
                            <div class="col-sm-10">
                                <input type="date" class="form-control" id="conStartDate" name="conStartDate" />
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="conEndDate" class="col-sm-2 col-form-label">행사 종료일</label>
                            <div class="col-sm-10">
                                <input type="date" class="form-control" id="conEndDate" name="conEndDate" />
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="subStartDate" class="col-sm-2 col-form-label">모집 시작일
                            </label>
                            <div class="col-sm-10">
                                <input type="date" class="form-control" id="subStartDate" name="subStartDate" />
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="subEndDate" class="col-sm-2 col-form-label">모집 종료일
                            </label>
                            <div class="col-sm-10">
                                <input type="date" class="form-control" id="subEndDate" name="subEndDate" />
                            </div>
                        </div>
                    </div>
                    <hr />
                    <div>
                        <h1>행사 장소</h1>
                        <br />
                        <fieldset class="row mb-3">
                            <legend class="col-form-label col-sm-2 pt-0"></legend>
                            <div class="col-sm-5">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="isOnoff" id="offline"
                                        value="true" checked />
                                    <label class="form-check-label" for="offline">
                                        오프라인
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="isOnoff" id="online"
                                        value="false" />
                                    <label class="form-check-label" for="online">
                                        온라인
                                    </label>
                                </div>
                                <div class="row mb-3">
                                    <label for="conLocation" class="col-sm-2 col-form-label">주소</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="conLocation" name="conLocation" />
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    <hr />

                    <h1>행사 가격 및 규모</h1>
                    <br />

                    <div class="row mb-3">
                        <!-- 제윤: 무료일 때 isFree: true, 유료일 때 isFree: false -->
                        <fieldset class="row mb-3">
                            <legend class="col-form-label col-sm-2 pt-0"></legend>
                            <div class="col-sm-5">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="conIsfree" id="paidRadio"
                                        value="false" />
                                    <label class="form-check-label" for="paidRadio">
                                        유료
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="conIsfree" id="freeRadio"
                                        value="true" checked />
                                    <label class="form-check-label" for="freeRadio">
                                        무료
                                    </label>
                                </div>
                                <div class="row mb-3">
                                    <label for="conPrice" class="col-sm-2 col-form-label">가격</label>
                                    <div class="col-sm-10">
                                        <input type="number" class="form-control" id="conPrice" name="conPrice"
                                            disabled />
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    <div class="row mb-3">
                        <label for="conPeople" class="col-sm-2 col-form-label">규모</label>
                        <div class="col-sm-10">
                            <input type="number" class="form-control" id="conPeople" name="conPeople" />
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="registerConference()">
                        행사 등록
                    </button>
                </form>
            </div>
            <br />
            <div></div>
            <br />
        </main>
        <%- include('../../common/footer.ejs') %>
            <script>
                $(document).ready(function () {
                    // 라디오 버튼의 변경 이벤트를 감지
                    $('input[type="radio"][name="isOnoff"]').change(function () {
                        // 선택한 라디오 버튼의 값을 가져옴
                        var selectedValue = $(this).val();

                        // 만약 "오프라인"을 선택했을 때
                        if (selectedValue === 'true') {
                            // 주소 입력 필드를 활성화
                            $('#conLocation').prop('disabled', false);
                        } else if (selectedValue === 'false') {
                            // "온라인"을 선택했을 때
                            // 주소 입력 필드를 비활성화하고 값을 지움
                            $('#conLocation').prop('disabled', true).val('');
                        }
                    });



                    // 라디오 버튼의 변경 이벤트를 감지
                    $('input[type="radio"][name="conIsfree"]').change(
                        function () {
                            // 선택한 라디오 버튼의 값을 가져옴
                            let selectedValue = $(this).val();

                            let isFree = selectedValue === 'true';

                            // 만약 "유료"를 선택했을 때
                            if (selectedValue === 'false') {
                                // 가격 입력 필드를 활성화
                                $('#conPrice').prop('disabled', false);
                            } else if (selectedValue === 'true') {
                                // "무료"를 선택했을 때
                                // 가격 입력 필드를 비활성화하고 값을 지움
                                $('#conPrice').prop('disabled', true).val('');
                            }
                            console.log('isFree 값: ', isFree);
                        }
                    );

                    // 가격 숫자만 추출
                    $("input:text[name='conPrice']").on("keyup", function () {
                        $(this).val($(this).val().replace(/[^0-9]/g, ""));
                    });
                });

                async function registerConference() {
                    const form = document.forms['register-conference'];


                    const formData = new FormData();
                    const file = document.querySelector('#dynamic-file');
                    formData.append('conferenceFile', file.files[0]);

                    const imageUploadRes = await axios({
                        method: 'POST',
                        url: '/upload/event',
                        data: formData,
                        header: {
                            'Content-Type': 'multipart/form-data', // enctype="multipart/form-data"
                        },
                    });
                    const imageUploadData = await imageUploadRes.data;

                    if (!imageUploadData.result) return alert('이미지 등록이 실패 되었습니다.');

                    console.log(imageUploadData.file);
                    const imagePath = imageUploadData.file.path;



                    const newImagePath = imagePath.replace("public/", "static/"); // public 경로를 static으로 변경

                    const conferenceRes = await axios({
                        method: 'POST',
                        url: '/event/write',
                        data: {
                            conTitle: form.conTitle.value,
                            conCompany: form.conCompany.value,
                            conStartDate: form.conStartDate.value,
                            conEndDate: form.conEndDate.value,
                            subStartDate: form.subStartDate.value,
                            subEndDate: form.subEndDate.value,
                            isOnoff: form.isOnoff.value,
                            conLocation: form.conLocation.value,
                            conCategory: form.conCategory.value,
                            conIsfree: form.conIsfree.value,
                            conPrice: form.conPrice.value === '' ? 0 : form.conPrice.value, // 빈값 일 때는 0 보내기 (이렇게 안하면 db 충돌남)
                            conPeople: form.conPeople.value,
                            conCompanyUrl: form.conCompanyUrl.value,
                            conImagePath: newImagePath,
                            conDetail: form.conDetail.value,
                        },
                    });
                    const conferenceData = await conferenceRes.data;



                    if (conferenceData.result) {
                        alert('등록이 완료되었습니다.')
                        document.location.href = '/event';
                    } else {
                        alert('등록에 실패하였습니다.')
                    }
                }


            </script>

</body>

</html>